{"ts":1342188576325,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var sip = require('sip');\r\nvar digest = require('sip/digest');\r\nvar util = require('util');\r\n\r\n\r\nvar mysipport = mysipport;\r\nvar myhost = 'ec2-23-22-135-42.compute-1.amazonaws.com';\r\nvar myhost = 'home.schnocklake.de'\r\n\r\n\r\n\r\n\r\nconsole.log('XXXXXXXXXXX    ADDRESS XXXXXXXXXXXXX');\r\nconsole.log('sip:' + myhost + ':' + mysipport);\r\n\r\n\r\nvar uri = 'sip:0435009722.320@sip12.e-fon.ch';\r\nvar cred = {\r\n  user: '0435009722.320',\r\n  password: 'parxwerk123',\r\n  realm: 'asterisk'\r\n};\r\n\r\n\r\n\r\nsip.start({\r\n  port: mysipport,\r\n\r\n\r\n  logger: { \r\n    send: function(message, address) { util.debug(\"send\\n\" + util.inspect(message, false, null)); },\r\n    recv: function(message, address) { util.debug(\"recv\\n\" + util.inspect(message, false, null)); }\r\n  }\r\n\r\n  }, function(rq) {\r\n  console.log('XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX');\r\n  console.log('XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX');    \r\n});\r\n\r\n\r\n\r\n\r\n\r\nvar inviteMsg = initInvite();\r\n\r\nfunction initInvite() {\r\nreturn {\r\n    method: 'INVITE',\r\n    uri: uri,\r\n    headers: {\r\n      to: {\r\n        uri: uri\r\n      },\r\n      from: {\r\n        uri: uri,\r\n        params: {\r\n          tag: '12345678'\r\n        }\r\n      },\r\n      'call-id': Math.floor(Math.random() * 1e6),\r\n      cseq: {\r\n        method: 'INVITE',\r\n        seq: 1\r\n      },\r\n//      'refer-to': uri,\r\n      contact: [{\r\n\r\n        uri: 'sip:' + myhost + ':' + mysipport\r\n      }]\r\n    }\r\n  };\r\n \r\n}\r\n\r\nvar invite2Msg;\r\n\r\nfunction initInvite2(rs) {\r\n  var retMsg = {\r\n          method: 'INVITE',\r\n          uri: 'sip:0041788223356@sip12.e-fon.ch',\r\n          headers: {\r\n            to: {\r\n              uri: 'sip:0041788223356@sip12.e-fon.ch'\r\n            },\r\n            from: {\r\n              uri: uri,\r\n              params: {\r\n                tag: '12345678'\r\n              }\r\n            },\r\n            'call-id': Math.floor(Math.random() * 1e6),\r\n            cseq: {\r\n              method: 'INVITE',\r\n              seq: 1\r\n            },\r\n      //      'refer-to': uri,\r\n            contact: [{\r\n\r\n              uri: 'sip:' + myhost + ':' + mysipport\r\n            }]\r\n          }\r\n        };\r\n \r\n    retMsg.content = rs.content;\r\n\tretMsg.headers['content-type'] = rs.headers['content-type'];\r\n\tretMsg.headers['content-length'] = rs.headers['content-length'];\r\n\treturn retMsg;\r\n}\r\n  \r\n\r\n\r\n\r\ninvite();\r\n\r\n\r\nfunction invite() {\r\ndelete inviteMsg.headers.via;\r\n  sip.send(inviteMsg, function(rs) {\r\n    console.log('CCCCCCCCCCCCC response on invite CCCCCCCCCCCCCCCC');\r\n    console.log(JSON.stringify(rs,null,'\\t'));    \r\n\r\n    if(rs.status === 407)  //reason Unauthorized\r\n    {  \r\n      digest.signRequest({\r\n        realm: cred.realm\r\n      }, inviteMsg, rs, cred);\r\n\r\n      invite();\r\n    } else if(rs.status === 200)  //reason OK\r\n    {\r\n      console.log('------------------------Invite OL------------------------------------');\r\n\tinvite2Msg = initInvite2(rs);\t\t\r\n\tinvite2();\r\n    }\r\n  \r\n  });\r\n}\r\n\r\n\r\nfunction invite2() {\r\ndelete invite2Msg.headers.via;\r\n  sip.send(invite2Msg, function(rs) {\r\n    console.log('CCCCCCCCCCCCC response on invite CCCCCCCCCCCCCCCC');\r\n    console.log(JSON.stringify(rs,null,'\\t'));    \r\n\r\n    if(rs.status === 407)  //reason Unauthorized\r\n    {  \r\n      digest.signRequest({\r\n        realm: cred.realm\r\n      }, invite2Msg, rs, cred);\r\n\r\n\t\r\n\r\n      invite2();\r\n    } else if(rs.status === 200)  //reason OK\r\n    {\r\n      console.log('------------------------Invite2 OK------------------------------------');\r\n      \r\n    }\r\n  \r\n  });\r\n}\r\n\r\n\r\n"]],"start1":0,"start2":0,"length1":0,"length2":3488}]],"length":3488}
