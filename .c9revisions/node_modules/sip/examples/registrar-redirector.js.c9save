{"ts":1340223123495,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"// Simple registrar - redirector\n//\n\nvar sip = require('sip');\nvar digest = require('sip/digest');\nvar util = require('util');\n\nvar registry = {};\n\nsip.start({\n  logger: { \n    send: function(message, address) { debugger; util.debug(\"send\\n\" + util.inspect(message, false, null)); },\n    recv: function(message, address) { debugger; util.debug(\"recv\\n\" + util.inspect(message, false, null)); }\n  }\n},\nfunction(rq) {\n  try {\n    if(rq.method === 'REGISTER') {  \n      \n      //looking up user info\n      var username = sip.parseUri(rq.headers.to.uri).user;\n      \n      registry[username] = rq.headers.contact;\n      \n      var rs = sip.makeResponse(rq, 200, 'Ok');\n      rs.headers.contact = rq.headers.contact;\n      sip.send(rs);\n    }\n    else if(rq.method === 'INVITE') {\n      var username = sip.parseUri(rq.uri).user;\n      var contacts = registry[username];\n      \n      if(contacts && Array.isArray(contacts) && contacts.length > 0) {\n        var rs = sip.makeResponse(rq, 302, 'Moved');\n        rs.headers.contact = contacts;\n        sip.send(rs);\n      }\n      else {\n        sip.send(sip.makeResponse(rq, 404, 'Not Found'));\n      }\n    }\n    else {\n      sip.send(sip.makeResponse(rq, 405, 'Method Not Allowed'));\n    }\n  } catch(e) {\n    util.debug(e);\n    util.debug(e.stack);\n\n    sip.send(sip.makeResponse(rq, 500, \"Server Internal Error\"));\n  }\n});\n\n"]],"start1":0,"start2":0,"length1":0,"length2":1367}]],"length":1367}
