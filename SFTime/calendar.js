function sf_searchCases(){var a="FIND {*"+searchTerm.term+"*} RETURNING Case(Id, Description, Subject, CaseNumber)  ";var b=oauth2_identity.urls.rest+"search/?q="+encodeURIComponent(a);var c={};c[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.GET;c[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;c[gadgets.io.RequestParameters.HEADERS]={Authorization:"OAuth "+token,"X-PrettyPrint":"1"};var d=function(a){if(a.data==null){responseFunc([]);return}var b=[];for(var c=0;c<a.data.length;c++){var d=a.data[c];b.push({label:d.Subject,value:d.Id})}responseFunc(b)};makeCachedRequest(b,d,c)}function makeCachedRequest(a,b,c,d){var e=(new Date).getTime();var f="?";if(d&&d>0){e=Math.floor(e/(d*1e3))}if(a.indexOf("?")>-1){f="&"}a=[a,f,"nocache=",e].join("");gadgets.io.makeRequest(a,b,c)}(function(a){function K(c,d){var e=b.startTime.year+"-"+(b.startTime.month<10?"0"+b.startTime.month:b.startTime.month)+"-"+(b.startTime.date<10?"0"+b.startTime.date:b.startTime.date);var f={};f.Case__c=c;f.Description__c=a("#Description").val();f.Timekeeper__c=""+k+"";f.RecordTypeID=""+j+"";f.Date__c=e;f.TimeStart__c=(b.startTime.hour<10?"0"+b.startTime.hour:b.startTime.hour)+""+(b.startTime.minute<10?"0"+b.startTime.minute:b.startTime.minute);f.HoursWorked__c=(b.endTime.hour*60+b.endTime.minute-(b.startTime.hour*60+b.startTime.minute))/60;var g="";for(i in f){g+="<"+i+">"+f[i]+"</"+i+">\n"}var h="";h+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:urn="urn:partner.soap.sforce.com" xmlns:urn1="urn:sobject.partner.soap.sforce.com">';h+="   <soapenv:Header>";h+="      <urn:SessionHeader>";h+="         <urn:sessionId>"+q.access_token+"</urn:sessionId>";h+="      </urn:SessionHeader>";h+="   </soapenv:Header>";h+="   <soapenv:Body>";h+="      <urn:create>";h+="         <urn:sObjects>";h+="            <urn1:type>TimeCard__c</urn1:type>";h+=g;h+="         </urn:sObjects>";h+="      </urn:create>";h+="   </soapenv:Body>";h+="</soapenv:Envelope>";var l={};l[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;l[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.DOM;l[gadgets.io.RequestParameters.POST_DATA]=h;l[gadgets.io.RequestParameters.HEADERS]={};l[gadgets.io.RequestParameters.HEADERS].SOAPAction="Dummy";l[gadgets.io.RequestParameters.HEADERS]["Content-Type"]="text/xml;charset=UTF-8";s("!!!!!!!!!!"+l);var m=function(a){s("!!!!!!!!!!!!!!!!!! sf_soap_insertTimeTicket callback obj :"+a);v()};makeCachedRequest(r.urls.partner,m,l)}function J(){var a="Select Id, Name from Contact "+" WHERE Email = '"+r.email+"' ";var b=r.urls.rest+"query/?q="+encodeURIComponent(a);var c={};c[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.GET;c[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;c[gadgets.io.RequestParameters.HEADERS]={Authorization:"OAuth "+q.access_token,"X-PrettyPrint":"1"};var d=[];var e=function(a){for(var b=0;b<a.data.records.length;b++){var c=a.data.records[b];k=c.Id}};makeCachedRequest(b,e,c)}function I(){var b="Select Id, Name, Case__r.Id, Case__r.Subject, Case__r.Description, Case__r.Project__r.Name, LastModifiedDate from TimeCard__c "+" WHERE Timekeeper__c = '"+k+"' order by LastModifiedDate desc Limit 50";var c=r.urls.rest+"query/?q="+encodeURIComponent(b);var d={};d[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.GET;d[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;d[gadgets.io.RequestParameters.HEADERS]={Authorization:"OAuth "+q.access_token,"X-PrettyPrint":"1"};var e=[];var f=function(b){a("select.Case").empty();for(var c=0;c<b.data.records.length;c++){var d=b.data.records[c];if(e.indexOf(d.Case__r.Id)<0&&e.length<20){e.push(d.Case__r.Id);var f=a("<option />").attr({value:d.Case__r.Id});f.html(d.Case__r.Subject+d.Case__r.Project__r.Name);s(f);a("select.Case").append(f)}}};makeCachedRequest(c,f,d)}function H(){var a="Select Id ,IsDeleted ,Name ,CurrencyIsoCode ,RecordTypeId ,CreatedDate ,CreatedById ,LastModifiedDate ,LastModifiedById ,SystemModstamp ,LastActivityDate ,ConnectionReceivedId ,ConnectionSentId ,Project__c ,Timekeeper__c ,Date__c ,HoursWorked__c ,Rate__c ,Task__c ,Description__c ,AmountWorked__c ,Case__c ,CaseSubject__c ,Invoice__c ,ShowOnReport__c ,HoursBillable__c ,RateInternal__c ,AmountBillable__c ,HoursUnbillable__c ,AmountUnbillable__c ,TimeStart__c ,CostInternal__c "+" FROM TimeCard__c "+" WHERE Timekeeper__c = '"+k+"'"+"   and Date__c >= "+e.year+"-"+(e.month<10?"0":"")+e.month+"-"+(e.date<10?"0":"")+e.date+" and Date__c <= "+f.year+"-"+(f.month<10?"0":"")+f.month+"-"+(f.date<10?"0":"")+f.date;var b=r.urls.rest+"query/?q="+encodeURIComponent(a);var d={};d[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.GET;d[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;d[gadgets.io.RequestParameters.HEADERS]={Authorization:"OAuth "+q.access_token,"X-PrettyPrint":"1"};var g={};var h=function(a){for(var b=0;b<a.data.records.length;b++){record=a.data.records[b];s(JSON.stringify(record));g[record.Id]=record}s(g);c=g;D()};makeCachedRequest(b,h,d,0)}function G(a){s(a)}function F(a){var b="https://www.googleapis.com/calendar/v3/calendars/"+encodeURIComponent(n)+"/events?sendNotifications=false&pp=1&key="+h;var c={};var d={};d.description=JSON.stringify(a);d.summary=a.Description__c;d.location="https://parxch.my.salesforce.com/"+a.Id+"?";var e=new Date(Date.parse(a.Date__c+"T"+a.TimeStart__c.substring(0,2)+":"+a.TimeStart__c.substring(2,4)+":00+01:00"));d.start={dateTime:e.format("isoUtcDateTime")};e=new Date(e.getTime()+a.HoursWorked__c*60*60*1e3);d.end={dateTime:e.format("isoUtcDateTime")};var f=JSON.stringify(d);c[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;c[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.OAUTH;c[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME]="google";c[gadgets.io.RequestParameters.OAUTH_USE_TOKEN]="always";c[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;c[gadgets.io.RequestParameters.POST_DATA]=f;c[gadgets.io.RequestParameters.HEADERS]={"X-PrettyPrint":"1","GData-Version":"3.0","Content-Type":"application/json"};makeCachedRequest(b,G,c)}function E(a){var b="https://www.googleapis.com/calendar/v3/calendars/"+encodeURIComponent(n)+"/events/"+a+"?pp=1&key="+h;var c={};var d="";c[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;c[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.OAUTH;c[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME]="google";c[gadgets.io.RequestParameters.OAUTH_USE_TOKEN]="always";c[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.DELETE;c[gadgets.io.RequestParameters.HEADERS]={"X-PrettyPrint":"1","GData-Version":"3.0","Content-Type":"application/json"};makeCachedRequest(b,null,c)}function D(){var a=[];var b=[];if(c!=null&&d!=null){}else{return}for(var e in c){s(e);if(d[e]!=null){s("compare");s(d[e].record.LastModifiedDate+" "+c[e].LastModifiedDate);if(d[e].record.LastModifiedDate==c[e].LastModifiedDate){s("gleich")}else{a.push(c[e]);b.push(d[e])}delete d[e];delete c[e]}else{a.push(c[e]);delete c[e]}}s("insert_timecards "+a);s("delete_timecards "+b);for(var e in d){b.push(d[e]);delete d[e]}for(var e in a){F(a[e])}for(var e in b){E(b[e].id)}google.calendar.refreshEvents();c=null;d=null}function C(){var a="https://www.googleapis.com/calendar/v3/calendars/"+encodeURIComponent(n)+"/events"+"?timeMax="+encodeURIComponent((new Date(f.year,f.month-1,f.date,23,59,59,999)).toISOString())+"&timeMin="+encodeURIComponent((new Date(e.year,e.month-1,e.date)).toISOString())+"&fields=items(description%2Cend%2CextendedProperties%2Cid%2Clocation%2Cstart%2Cstatus%2Csummary%2Cupdated)%2Cupdated&pp=1"+"&key="+h;s("callUrl "+a);var b={};var c="";b[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;b[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.OAUTH;b[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME]="google";b[gadgets.io.RequestParameters.OAUTH_USE_TOKEN]="always";b[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.GET;b[gadgets.io.RequestParameters.HEADERS]={"X-PrettyPrint":"1","GData-Version":"3.0","Content-Type":"application/json"};var g=function(a){d={};if(a.data!=null&&a.data.items!=null){for(var b=0;b<a.data.items.length;b++){var c=a.data.items[b];s(c.id);c.record=JSON.parse(c.description);d[c.record.Id]=c}}D()};makeCachedRequest(a,g,b)}function B(){a("#errors").hide();var c=function(c){if(c.oauthApprovalUrl){var d=shindig.oauth.popup({destination:c.oauthApprovalUrl,windowOptions:"height=600,width=800",onOpen:function(){u("waiting")},onClose:function(){u("loading");B()}});a("#personalize").get(0).onclick=d.createOpenerOnClick();a("#approvalLink").get(0).onclick=d.createApprovedOnClick();u("approval")}else if(c.data){u("main");if(b==null){a("#dialog")[0].style.display="none"}for(i in c.data.items){var e=c.data.items[i];if(e.summary=="Timecards"||e.summary=="TimeCards"){l=e.description.split("/")[0];m=e.description.split("/")[1];n=e.id}}x()}else{if(console&&console.debug){console.debug(c.stack)}a("#errors").html("Something went wrong").fadeIn();u("errors")}};var d="https://www.googleapis.com/calendar/v3/users/me/calendarList?minAccessRole=owner&pp=1&key="+h;var e={};e[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;e[gadgets.io.RequestParameters.AUTHORIZATION]=gadgets.io.AuthorizationType.OAUTH;e[gadgets.io.RequestParameters.OAUTH_SERVICE_NAME]="google";e[gadgets.io.RequestParameters.OAUTH_USE_TOKEN]="always";e[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.GET;e[gadgets.io.RequestParameters.HEADERS]={"X-PrettyPrint":"1","GData-Version":"3.0","Content-Type":"application/json"};makeCachedRequest(d,c,e)}function A(a){if(o===null)o={};if(a.origin=="https://s3.amazonaws.com"){var b=a.data.split("?")[1].split("&");for(var c in b){var d=b[c].split("=");o[d[0]]=decodeURIComponent(d[1])}s(o);var e="grant_type=authorization_code&"+"code="+encodeURIComponent(o.code)+"&client_id="+encodeURIComponent(l)+"&client_secret="+encodeURIComponent(m)+"&redirect_uri="+encodeURIComponent(p)+"&state=gettoken&format=json";var f={};f[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;f[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;f[gadgets.io.RequestParameters.POST_DATA]=e;f[gadgets.io.RequestParameters.HEADERS]={"Content-Type":"application/x-www-form-urlencoded","X-PrettyPrint":"1"};makeCachedRequest("https://login.salesforce.com/services/oauth2/token",y,f)}}function z(){var a="grant_type=refresh_token&"+"client_id="+encodeURIComponent(l)+"&client_secret="+encodeURIComponent(m)+"&refresh_token="+encodeURIComponent(q.refresh_token)+"&format=json";var b={};b[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;b[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.POST;b[gadgets.io.RequestParameters.POST_DATA]=a;b[gadgets.io.RequestParameters.HEADERS]={"Content-Type":"application/x-www-form-urlencoded","X-PrettyPrint":"1"};makeCachedRequest("https://login.salesforce.com/services/oauth2/token",y,b)}function y(b){s(b.data);q=b.data;if(b.rc!=200){var c=new gadgets.Prefs;c.set("refresh_token",null);x();return}if(q.refresh_token){var c=new gadgets.Prefs;c.set("refresh_token",q.refresh_token)}var d={};d[gadgets.io.RequestParameters.CONTENT_TYPE]=gadgets.io.ContentType.JSON;d[gadgets.io.RequestParameters.METHOD]=gadgets.io.MethodType.GET;d[gadgets.io.RequestParameters.HEADERS]={Accept:"application/json","X-PrettyPrint":"1",Authorization:"OAuth "+q.access_token};var e=function(b){s(b.data);r=b.data;for(i in r.urls){r.urls[i]=r.urls[i].replace("{version}",g)}u("main");a(".refresh").get(0).style.display="";gadgets.window.adjustHeight();J()};makeCachedRequest(q.id,e,d)}function x(){var b=new gadgets.Prefs;var c=b.getString("refresh_token");if(c&&c!=""){q={};q.refresh_token=c;z();return}var d="https://login.salesforce.com/services/oauth2/authorize?response_type=code"+"&client_id="+encodeURIComponent(l)+"&redirect_uri="+encodeURIComponent(p)+"&state=mystate";var e=shindig.oauth.popup({destination:d,windowOptions:"height=600,width=800",onOpen:function(){u("waiting")},onClose:function(){u("loading")}});a("#personalize").get(0).onclick=e.createOpenerOnClick();a("#personalize").text("Authorize Salesforce");a("#approvalLink").get(0).onclick=e.createApprovedOnClick();u("approval")}function w(c){if(c){s(gadgets.json.stringify(c));if(!c.calendar||c.calendar&&c.calendar.email&&c.calendar.email==n){b=c;a("#dialog").get(0).style.display="block";gadgets.window.adjustHeight();I()}}else{b=null;a("#dialog").get(0).style.display="none";s("kein event");gadgets.window.adjustHeight()}}function v(){C();H();google.calendar.refreshEvents();var a="google.calendar.showDate(2009, 12, 31);google.calendar.showDate("+e.year+","+e.month+","+e.date+");";setTimeout(a,2e3);setTimeout(a,5e3)}function u(b){var c=["main","approval","waiting","loading","errors"];for(var d=0,e;e=c[d];++d){a("#"+e).get(0).style.display=e===b?"block":"none"}}function t(){google.calendar.read.subscribeToEvents(w);google.calendar.subscribeToDates(function(a){e=a.startTime;f=a.endTime});a(".credentials").addClass("invisible");a(".refreshCal").click(function(a){a.preventDefault();v()});a(".SaveEvent").click(function(b){b.preventDefault();var c=a("#Case").val();var d=a('option[value|="'+c+'"]').text();K(c,d);return false});gadgets.window.adjustHeight();window.addEventListener("message",A,false);B()}function s(a){if(true){if(console&&console.debug){console.debug(a)}}}var b=null;var c=null;var d=null;var e=null;var f=null;var g="23.0";var h="AIzaSyA9r8BLyijx8Wng-Ow1zG8AZ5-FHEoGZ8Q";var j="012D0000000Uu3y";var k=null;var l=null;var m=null;var n=null;var o=null;var p="https://s3.amazonaws.com/tsschnocwinn/oAuthcallback.html";var q=null;var r=null;gadgets.util.registerOnLoadHandler(t)})(jQuery);var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,d=function(a,b){a=String(a);b=b||2;while(a.length<b)a="0"+a;return a};return function(e,f,g){var h=dateFormat;if(arguments.length==1&&Object.prototype.toString.call(e)=="[object String]"&&!/\d/.test(e)){f=e;e=undefined}e=e?new Date(e):new Date;if(isNaN(e))throw SyntaxError("invalid date");f=String(h.masks[f]||f||h.masks["default"]);if(f.slice(0,4)=="UTC:"){f=f.slice(4);g=true}var i=g?"getUTC":"get",j=e[i+"Date"](),k=e[i+"Day"](),l=e[i+"Month"](),m=e[i+"FullYear"](),n=e[i+"Hours"](),o=e[i+"Minutes"](),p=e[i+"Seconds"](),q=e[i+"Milliseconds"](),r=g?0:e.getTimezoneOffset(),s={d:j,dd:d(j),ddd:h.i18n.dayNames[k],dddd:h.i18n.dayNames[k+7],m:l+1,mm:d(l+1),mmm:h.i18n.monthNames[l],mmmm:h.i18n.monthNames[l+12],yy:String(m).slice(2),yyyy:m,h:n%12||12,hh:d(n%12||12),H:n,HH:d(n),M:o,MM:d(o),s:p,ss:d(p),l:d(q,3),L:d(q>99?Math.round(q/10):q),t:n<12?"a":"p",tt:n<12?"am":"pm",T:n<12?"A":"P",TT:n<12?"AM":"PM",Z:g?"UTC":(String(e).match(b)||[""]).pop().replace(c,""),o:(r>0?"-":"+")+d(Math.floor(Math.abs(r)/60)*100+Math.abs(r)%60,4),S:["th","st","nd","rd"][j%10>3?0:(j%100-j%10!=10)*j%10]};return f.replace(a,function(a){return a in s?s[a]:a.slice(1,a.length-1)})}}();dateFormat.masks={"default":"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"};dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]};Date.prototype.format=function(a,b){return dateFormat(this,a,b)};var shindig=shindig||{};shindig.oauth=shindig.oauth||{};shindig.oauth.popup=function(a){function k(){return h}function j(){return function(){f=window.open(b,"_blank",c);TestWin=f;if(f){g=window.setInterval(i,100);d()}return false}}function i(){if(!f||f.closed){f=null;h()}}function h(){if(g){window.clearInterval(g);g=null}if(f){f.close();f=null}e();return false}if(!("destination"in a)){throw"Must specify options.destination"}if(!("windowOptions"in a)){throw"Must specify options.windowOptions"}if(!("onOpen"in a)){throw"Must specify options.onOpen"}if(!("onClose"in a)){throw"Must specify options.onClose"}var b=a.destination;var c=a.windowOptions;var d=a.onOpen;var e=a.onClose;var f=null;var g=null;return{createOpenerOnClick:j,createApprovedOnClick:k}}