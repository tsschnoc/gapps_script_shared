From cdab7fc428cac630f65d1eae5b0dbccd4ea68298 Mon Sep 17 00:00:00 2001
From: Rob Gulewich <robert.gulewich@joyent.com>
Date: Mon, 20 Aug 2012 15:43:14 -0700
Subject: [PATCH] Log req/res body if present (as per the restify audit
 logger)

---
 bin/bunyan |   20 ++++++++++++++++----
 1 file changed, 16 insertions(+), 4 deletions(-)

diff --git a/bin/bunyan b/bin/bunyan
index db15e06..61ff203 100755
--- a/bin/bunyan
+++ b/bin/bunyan
@@ -614,30 +614,39 @@ function emitRecord(rec, line, opts, stylize) {
 
     if (rec.req) {
       var headers = rec.req.headers;
-      details.push(indent(format("%s %s HTTP/1.1%s", rec.req.method,
+      var s = format("%s %s HTTP/1.1%s", rec.req.method,
         rec.req.url,
         (headers
           ? '\n' + Object.keys(headers).map(
               function (h) { return h + ': ' + headers[h]; }).join('\n')
           : '')
-      )));
+      );
+      if (rec.req.body) {
+        s += '\n\n' + rec.req.body
+      }
+      details.push(indent(s));
     }
     delete rec.req;
 
     if (rec.client_req) {
       var headers = rec.client_req.headers;
       var hostHeaderLine = '';
+      var s = '';
       if (rec.client_req.address) {
         hostHeaderLine = 'Host: ' + rec.client_req.address;
         if (rec.client_req.port)
           hostHeaderLine += ':' + rec.client_req.port;
         hostHeaderLine += '\n';
       }
-      details.push(indent(format("%s %s HTTP/1.1\n%s%s", rec.client_req.method,
+      s += format("%s %s HTTP/1.1\n%s%s", rec.client_req.method,
         rec.client_req.url,
         hostHeaderLine,
         Object.keys(headers).map(
-          function (h) { return h + ': ' + headers[h]; }).join('\n'))));
+          function (h) { return h + ': ' + headers[h]; }).join('\n'));
+      if (rec.client_req.body) {
+        s += '\n\n' + rec.client_req.body
+      }
+      details.push(indent(s));
     }
     delete rec.client_req;
 
@@ -654,6 +663,9 @@ function emitRecord(rec, line, opts, stylize) {
         s += Object.keys(headers).map(
           function (h) { return h + ': ' + headers[h]; }).join('\n');
       }
+      if (rec.res.body) {
+        s += '\n\n' + rec.res.body
+      }
       if (s) {
         details.push(indent(s));
       }
-- 
1.7.10

